<?php require_once('/var/www/auth/user.php'); ?>
<?php $user->require_login(); ?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" >

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <title>CuPID Dataviewer</title>

    <script src="/js/jquery-1.11.0.min.js"></script>
    <script src="/js/jquery-migrate-1.2.1.min.js"></script>

    <link rel="stylesheet" href="css/jquery.mobile-1.2.1.css" />
    <script src="js/jquery.mobile-1.2.1.js"></script>

    <link rel="stylesheet" href="css/jqm-docs.css" />
    <link rel="stylesheet" href="css/CuPID.css" />
    <script src="js/jqm-docs.js"></script>

    <script language="javascript" type="text/javascript" src="js/jqplot/jquery.jqplot.min.js"></script>
    <link rel="stylesheet" type="text/css" href="js/jqplot/jquery.jqplot.css" />
    <script type="text/javascript" src="js/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script type="text/javascript" src="js/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="js/jqplot/plugins/jqplot.dateAxisRenderer.js"></script>
    <script type="text/javascript" src="js/jqplot/plugins/jqplot.cursor.min.js"></script>
    <script type="text/javascript" src="js/jqplot/plugins/jqplot.highlighter.js"></script>

    <script src="/js/iijslib.js" type="text/javascript"></script>
    <script src="/js/cupidjslib.js" type="text/javascript"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-48449692-4', 'auto');
      ga('send', 'pageview');
    </script>
</head>
<body>
<!--Record auth level-->
<script type="text/javascript">
var sessiondata = {}
sessiondata.username = "<?php if (!empty($_SESSION['user']['name'])) { echo $_SESSION['user']['name'];} ?>";
sessiondata.sessionid = "<?php if (!empty($_SESSION['user']['sessionid'])) {echo $_SESSION['user']['sessionid'];} ?>";
sessiondata.appip =  "<?php if (!empty($_SESSION['user']['appip'])) {echo $_SESSION['user']['appip'];} ?>";
sessiondata.realip =  "<?php if (!empty($_SESSION['user']['realip'])) {echo $_SESSION['user']['realip'];} ?>";
sessiondata.authlevel =  "<?php if (!empty($_SESSION['user']['authlevel'])) {echo $_SESSION['user']['authlevel'];} ?>";

// <!--Log access-->
logUserAuths(sessiondata)
</script>

<div data-role="page" class="type-home" id="main">

<script>

// define some globals
var jqmpage=true;
var updatetimeout=100;
var loginterval=30000;
var updateinterval=30000;
var lognames = [];
var ioinfo = [];
var ioinfonames = [];
var ioinfoids = [];
var labeltype = 'ids';
var labelincludevalue = true;

// globals for selected items
var seriesids=[];
var tablenames=[];
var seriesshortnames=[];
var seriesnames=[];
var actauthlevel=2;

// load ioinfo into DOM
function GetIOInfo(callbackoptions) {
    var callbackoptions = callbackoptions || {}
    var callback=RenderIOInfoTable;
    wsgiCallbackTableData(controldatabase,'ioinfo',callback,callbackoptions)
}
function RenderIOInfoTable(datatable) {
    ioinfo = datatable;
    ioinfonames = [];
    ioinfoids = [];
    for (var i=0; i<datatable.length; i++){
        ioinfoids.push(datatable[i].id)
        ioinfonames.push(datatable[i].name)
    }
}

//// Channels
function UpdateLogTable() {
    var callback=RenderLogsTable;
    var callbackoptions={}
    wsgiGetTableNames(logdatabase,callback,callbackoptions)
}
function RenderLogsTable(datatable) {
    lognames = datatable;
    $('#logdatalistview').empty()
    $('#logdatalistview').append('\
        <li data-role="list-divider">\
            <h4>Content Selection</h4>\
        </li>'
    )
    // prune off the metadata table
    for (var i=0;i<datatable.length-1;i++){
        $('#logdatalistview').append('\
            <li data-role="fieldcontain" id="logdataset" >\
                <p class="ui-block-a ui-biglabel" style="width: 100%">' + datatable[i] + '</p>\
                <fieldset class="ui-grid-a" style="margin-top:40px">\
                    <div class="ui-block-a" style="width:75%" >\
                        <label for="none' + datatable[i] + 'toggle" style="font-size:14px; margin-left: 0px; margin-right: 5px; position: relative; top:-6px">Plot</label>\
                        <select id="plotme' + datatable[i] + 'toggle" class="plotme' + datatable[i] + 'toggle plottoggle" data-role="slider">\
                        <option value="Off">Off</option>\
                        <option value="On">On</option>\
                        </select>\
                    </div>\
                    <div class="' + datatable[i].replace(/ /g,'_') + 'points ui-block-b ui-btn-up-d  ui-btn-corner-all cnt" style="float:right; margin:3px 1px 5px 0px; padding: 7px 10px; text-align: center; width: 60px">52\
                    </div>\
                </fieldset>\
            </li>'
        )
    }
    $('#logdatalistview').listview('refresh')
    $('#logdatalistview').trigger("create")
}

function GetPlotSeriesNamesFromViewerControls(){

    // Ok, this is confusing as hell.
    // Seriesshortnames are what we want to use for a colloquial name for the series
    // seriesnames are what the name of the value is that we're getting from the table, e.g. 'value' or 'controlvalue'

    var thisseriesid;
    tablenames = [];
    seriesids = [];
    seriesshortnames = [];
    seriesnames = [];
    $('.plottoggle').each(function(index,element){
        if (this.value=="On"){
            tablenames.push(lognames[index]);
            var thisseriesmeta = parseLogTableName(lognames[index]);

            seriesids.push(thisseriesmeta.id);
            if (thisseriesmeta.type == 'input') {
                seriesnames.push('value');
                if (ioinfoids.indexOf(thisseriesmeta.id) > 0) {
                    seriesshortnames.push(ioinfonames[ioinfoids.indexOf(thisseriesmeta.id)]);
                }
                else {
                    seriesshortnames.push(thisseriesmeta.id);
                }
            }
            else if (thisseriesmeta.type == 'channel') {
                seriesshortnames.push(thisseriesmeta.id);
                seriesnames.push('controlvalue');
            }

        }
    });


    var results={seriesnames: seriesnames, seriesshortnames:seriesshortnames,tablenames:tablenames, seriesids:seriesids}
    return results
}

function updatePlots(renderoptions){
      renderoptions = renderoptions || {}

//    if ( ! renderoptions.hasOwnProperty('renderplotids')) {
        var activePage = $.mobile.activePage.attr("id");
        if (activePage == 'main'){
            renderoptions.renderplotids = ['plot']
        }
        else {
            renderoptions.renderplotids = ['fullplot']
            console.log('full plot!')
        }
//    }
    var results = GetPlotSeriesNamesFromViewerControls();
    var tablenames = results.tablenames;

    if (labeltype == 'names')
        {var serieslabels = results.seriesshortnames;}
    else if (labeltype == 'ids')
        {var serieslabels = results.seriesids;}
    else
        {var serieslabels = results.tablenames;}

    // Get total number of series and label appropriately
    var customOptionsObj=channelOptionsObj;

    customOptionsObj.series=[]
    var passedserieslabels = []
    var seriesnames = []
    for (var i = 0; i < serieslabels.length; i++) {
        customOptionsObj.series.push([{label: serieslabels[i], axis: 'yaxis'}])
        passedserieslabels.push([serieslabels[i]])
        seriesnames.push([results.seriesnames[i]])
    }

    var length = $('#plotpointsslider').val();
    renderoptions.tablenames = tablenames;
    renderoptions.seriesnames = seriesnames;
    renderoptions.serieslabels = passedserieslabels;
    renderoptions.labelincludevalue = labelincludevalue;
    renderoptions.includelabelvalueprecision = $('#includelabelvalueprecision').val();
    renderoptions.renderplotoptions = [customOptionsObj];
    renderoptions.length = parseInt(length);
    renderoptions.start = -1;

    GetAndRenderMultLogsData(logdatabase,renderoptions);
    //GetAndRenderLogData({logtablename:'input_DS18B20-1_log','seriesnames':['value'],renderplotids:['plot'],renderplotoptions:[channelOptionsObj]})
}
$(document).ready(function(){
    togglestolamps()

    //// Control Algorithms
    // UpdateLogsTable({'timeout':updateinterval})
    $('#plotrefresh').click(function(event){
        var renderoptions = {renderplotids:['plot']};
        updatePlots(renderoptions)
    });
    $('#fullplotrefresh').click(function(event){
        var renderoptions = {renderplotids:['fullplot']};
        updatePlots(renderoptions)
    });

    $('#plotlabelidsbutton').click(function(){
        $('#plotlabelnamesbutton').removeClass('ui-btn-active')
        $('#plotlabelidsbutton').removeClass('ui-btn-active')
        $('#plotlabeltablenamesbutton').removeClass('ui-btn-active')

        $('#plotlabelidsbutton').addClass('ui-btn-active')
        labeltype = 'ids'
        $('#maincontrolgroup').listview('refresh');
    })
    $('#plotlabelnamesbutton').click(function(){
        $('#plotlabelnamesbutton').removeClass('ui-btn-active')
        $('#plotlabelidsbutton').removeClass('ui-btn-active')
        $('#plotlabeltablenamesbutton').removeClass('ui-btn-active')

        $('#plotlabelnamesbutton').addClass('ui-btn-active')
        labeltype = 'names'
        $('#maincontrolgroup').listview('refresh');
    })
    $('#plotlabeltablenamesbutton').click(function(){
        $('#plotlabelnamesbutton').removeClass('ui-btn-active')
        $('#plotlabelidsbutton').removeClass('ui-btn-active')
        $('#plotlabeltablenamesbutton').removeClass('ui-btn-active')

        $('#plotlabeltablenamesbutton').addClass('ui-btn-active')
        labeltype = 'tablenames'
        $('#maincontrolgroup').listview('refresh');
    })
    $('#includelabelvalue').click(function(){
        if (labelincludevalue) {
            $('#includelabelvalue').removeClass('ui-btn-active');
            labelincludevalue = false;
        }
        else {
            $('#includelabelvalue').addClass('ui-btn-active');
            labelincludevalue = true;
        }
        $('#maincontrolgroup').listview('refresh');
    })

    UpdateLogTable()
    setTimeout(function(){
        UpdatePlotMetadata({'timeout':'2000'})
    },1000);
     setTimeout(function(){
        GetIOInfo({'timeout':'2000'})
    },1000);

    // This is some interesting stuff. We put the callback to the top-level function in here, so
    // that when it's called from deeper it pulls in everything new. To do so, however, we need to
    // create a closure. It works great, if you can wrap your head around it.

    setTimeout(function(){
        var optionsobject = {'timeoutclass':'updateperiodwidget'};
        var callback = function(){updatePlots(optionsobject)};
        optionsobject.callback = callback;
        updatePlots(optionsobject)
    },1000);

//    setTimeout(function(){updatePlots({timeoutclass:'updateperiodwidget'})},3000)
});

</script>
<div data-role="content">
    <div class="content-secondary" >
        <ul data-role="listview" data-inset="true" id='maincontrolgroup' style="margin-bottom:20px">
            <li data-role="list-divider"><h4>Controls</h4></li>
            <div data-role="collapsible" data-collapsed="true" data-inset="false" data-count-theme="b" data-content-theme="b">
                <h4>Plot</h4>
                <li class="sm-inset-header">
                    <label for="plotpointsslider" style="width:100%; padding-right:40px">Plot Points</label>
                    <input type="range" id="plotpointsslider" class="plotpointsslider" value="1000" min="0" max="1000" />
                </li>
                <li class="sm-inset-header">
                    <label for="updateperiodwidget" style="width:100%; padding-right:40px">Update Frequency</label>
                    <input type="range" id="updateperiodwidget" class="updateperiodwidget" value="10" min="0" max="100" />
                </li>
                <div data-role="controlgroup" data-type="horizontal" id="plotlabelsgroup">
                    <div>Plot label type</div>
                    <a data-role="button" id="plotlabeltablenamesbutton">Tablenames</a>
                    <a data-role="button" id="plotlabelidsbutton" class="ui-btn-active">IDs</a>
                    <a data-role="button" id="plotlabelnamesbutton" >Short Names</a>
                </div>
                <div class="ui-grid-a" style="margin-top:40px" class="numericonlyslider">
                    <div class="ui-block-a" style="width:35%">
                    <div>Include Value in Label</div>
                        <a data-role="button" id="includelabelvalue" class="includelabelvalue ui-btn-active" style="width:150px">Include</a>
                    </div>
                    <div class="ui-block-b" style="width:60%">
                        <label for="includelabelvalueprecision">Precision</label>
                        <input type="range" id="includelabelvalueprecision" class="includelabelvalueprecision" value="5" min="0" max="10" />
                    </div>
                </div>
            </div>
            <li data-role="fieldcontain">
                <a href="logviewer.html" data-ajax="false">Log Viewer</a>
            </li>
        </ul>

        <ul data-role="listview" data-inset="true" data-dividertheme="c" id="logdatalistview">
            <li data-role="list-divider">
                <h4>Content Selection</h4>
            </li>
            <li data-role="fieldcontain">
                &nbsp;
            </li>
        </ul>
    </div><!--/content-secondary-->
    <div class="content-primary">
        <div data-role="button" data-theme="c" id="plotrefresh">Refresh Plot</div>
        <ul data-role="listview" data-inset="true" data-dividertheme="c" id="channellistview">
            <li data-role="list-divider">
                <h4>Data Plot</h4>
            </li>
            <li data-role="fieldcontain" >
                <div id="plot" class="plots" ></div>
            </li>
        </ul>
        <div><a href="#fullplotpage" data-role="button">Full Screen Plot</a></div>
    </div><!--content-primary-->
    </div><!--content-->
    <div data-role="footer" data-id='fixednav' data-position="fixed" >
        <div data-role="navbar" data-iconpos="left">
            <ul>
                <li ><a href="/mobile/index.html" data-icon="home" >Home</a></li>
                <?php
                    if($user->logged_in()):
                    ?>
                        <li><span class="ui-btn-text ui-btn-inner" style="text-align: center; padding-top: 0.7em!important; padding-left: 0px!important; padding-right: 0px!important"><?php echo $_SESSION['user']['name']; ?></span></li>
                        <li><a data-ajax="false" href="/auth/logoutmobile">Log out</a></li>
                        <?php
                    endif;
                    if(!$user->logged_in()):
                    ?>
                        <li><div class="ui-btn-text ui-btn-inner" style="text-align: center; padding-top: 0.7em!important; padding-left: 0px!important; padding-right: 0px!important">Not logged in</div></li>
                        <li><a data-ajax="false" href="/auth/loginmobile" style="padding-right:10px">Log in</a></li>
                    <?php
                        endif;
                    ?>
            </ul>
        </div>
  </div><!--footer-->
</div><!-- page -->

<div data-role="page" id="fullplotpage">
<script>
    $( document ).on( "pageinit", "#fullplotpage", function( event ) {
        togglestolamps()
        var results=GetPlotSeriesNamesFromViewerControls();
        var tablenames = results.tablenames;

        // we'll choose ids or names here.
        var serieslabels = results.seriesnames;

        // Get total number of series and label appropriately
        var customOptionsObj=channelOptionsObj;
        var totalseries=0;
        customOptionsObj.series=[]
        for (var i=0; i<seriesnames.length;i++){
            for (var j=0;j<seriesnames[i].length;j++){
                customOptionsObj.series.push({label:tablenames[i] + ' : ' + seriesnames[i][j], axis:'yaxis'})
            }
            totalseries+=seriesnames[i].length;
        }
        GetAndRenderMultLogsData(logdatabase,{'tablenames':tablenames,'serieslabels':serieslabels,renderplotids:['fullplot'],renderplotoptions:[customOptionsObj]})
    });
</script>
    <div data-role="content">
        <div class="content-primary" style="width:90%">
            <ul data-role="listview" data-inset="true" datadividertheme="c">
                <li data-role="list-divider">
                    <h4>Full Plot</h4>
                </li>
                <li data-role="fieldcontain" >
                    <div id="fullplot" class="fullplots" ></div>
                </li>
            </ul>
            <div data-role="button" data-theme="c" id="fullplotrefresh">Refresh Plot</div>
        </div>
    </div>
</div><!-- page -->
</body>
</html>
