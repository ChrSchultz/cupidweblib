<?php require_once('../auth/user.php'); ?>
<?php $user->require_login(); ?>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CuPID System Logs</title>
	<link rel="stylesheet" href="css/jquery.mobile-1.2.1.css" />
	<link rel="stylesheet" href="css/jqm-docs.css" />
    <link rel="stylesheet" href="css/CuPID.css" />
	<script src="/js/jquery-1.11.0.min.js"></script>
    <script src="/js/jquery-migrate-1.2.1.min.js"></script>
	<script src="js/jqm-docs.js"></script>
	<script src="js/jquery.mobile-1.2.1.js"></script>
    <script src="/js/iijslib.js" type="text/javascript"></script> 
	<script src="/js/cupidjslib.js" type="text/javascript"></script>
</head>
<body>
<!--Record auth level-->
<script type="text/javascript">
var sessiondata = {}
sessiondata.username = "<?php if (!empty($_SESSION['user']['name'])) { echo $_SESSION['user']['name'];} ?>";
sessiondata.sessionid = "<?php if (!empty($_SESSION['user']['sessionid'])) {echo $_SESSION['user']['sessionid'];} ?>";
sessiondata.appip =  "<?php if (!empty($_SESSION['user']['appip'])) {echo $_SESSION['user']['appip'];} ?>";
sessiondata.realip =  "<?php if (!empty($_SESSION['user']['realip'])) {echo $_SESSION['user']['realip'];} ?>";
sessiondata.authlevel =  "<?php if (!empty($_SESSION['user']['authlevel'])) {echo $_SESSION['user']['authlevel'];} ?>";
sessiondata.hpass =  "<?php if (!empty($_SESSION['user']['authlevel'])) {echo $_SESSION['user']['hpass'];} ?>";

// <!--Log access-->
logUserAuths(sessiondata)
</script>

<div data-role="page" class="type-home" id="main">
<script>
var updateinterval=3000

function UpdateSystemLogData(options) {
    var callback = RenderSystemLogData;
    options.action = 'getfiletext';
    options.filepath = '/var/log/cupid/systemstatus.log';
    options.numlines = 20;
    runwsgiActions(options, callback)
}

function RenderSystemLogData(returndata,options) {
//    console.log(options)
//    console.log('i should not be running')
    if (options.timeout>0) {
		setTimeout(function(){UpdateSystemLogData(options)}, options.timeout);
	}
    $('#logdata').html('')
    for (var i=0; i<returndata['data'].length; i++){
//        console.log(returndata['data'][i])
        $('#logdata').append(returndata['data'][i] + '<br />')
    }
}


$(document).ready(function(){
    UpdateSystemLogData({timeout:updateinterval})
})


</script>
<div data-role="content">
    <div class="content-secondary">
		<ul data-role="listview" data-inset="true" data-theme="b" data-dividertheme="b" id="userslistview">
            <li data-role="list-divider"><h4>Log Viewer</h4></li>
            <li data-role="fieldcontain">
                <p><span id="logdata">&nbsp;</span></p>
            </li>
        </ul>
    </div><!--/content-secondary-->

</div><!--content-->
</div><!-- page -->
</body>
</html>
