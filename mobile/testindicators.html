
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" >


<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

<title>CuPID Control Panel</title>
<link rel="stylesheet" href="css/jquery.mobile-1.2.1.css" />
<link rel="stylesheet" href="css/jqm-docs.css" />
<link rel="stylesheet" href="css/CuPID.css" />
<script src="js/jquery-1.7.1.min.js"></script>
<script src="js/jqm-docs.js"></script>
<script src="js/jquery.mobile-1.2.1.js"></script>

<script language="javascript" type="text/javascript" src="js/jqplot/jquery.jqplot.min.js"></script>
<link rel="stylesheet" type="text/css" href="js/jqplot/jquery.jqplot.css" />
<script type="text/javascript" src="js/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
<script type="text/javascript" src="js/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
<script type="text/javascript" src="js/jqplot/plugins/jqplot.dateAxisRenderer.js"></script>
<script type="text/javascript" src="js/jqplot/plugins/jqplot.cursor.min.js"></script>

<script src="/js/iijslib.js" type="text/javascript"></script> 
<script src="/js/cupidjslib.js" type="text/javascript"></script>
</head>
<body>

<div data-role="page" class="type-home" id="main">
<script>

// Define our usr for access control of features:


// Set objects. not used yet.
var plotdefs = new plotdefs()
plotdefs.plotids=[]
plotdefs.series=[[[]]]
plotdefs.plotids.push('myplotid')
plotdefs.series.push([[['/var/www/data/controldata.db','channels','channel 1data']]])

// define some globals


var updatetimeout=100
var loginterval=30000
var updateinterval=15000

var actauthlevel=2
var stdmessage='You do not have sufficient authorization for this action'

	  
	  // setpoint slider change value
	  $( "#channelsetpointvalueslider" + i ).on( 'slidestop', { index: i}, function( event ) { 
	    var data=event.data
		value=$(this).val()
		//alert("#channelsetpointvalueslider" + data.index)
		actionobj ={'action':'spchange','subaction':'setvalue','database':controldatabase,'channelname':channelsdata[data.index].name, 'value':value}
		// invoke ajax query with callback to update the interface when it's done
		UpdateControl(actionobj,UpdateChannelsData)
	  });
	  
	  // Toggle manual/auto
	  $( "#channelmodeautomantoggle" + i ).on( 'slidestop', { index: i}, function( event ) { 
	    var data=event.data
		value=$(this).val()
		//alert("#channelsetpointvalueslider" + data.index)
		actionobj ={'action':'setmode','newmode': value,'database':controldatabase,'channelname':channelsdata[data.index].name}
		// invoke ajax query with callback to update the interface when it's done
		UpdateControl(actionobj,UpdateChannelsData)
	  });
	  
	  // Toggle channel enabled
	  $( "#channelenabledtoggle" + i ).on( 'slidestop', { index: i}, function( event ) { 
	    var data=event.data
		value=$(this).val()
		//alert("#channelsetpointvalueslider" + data.index)
		actionobj ={'action':'setmode','newmode': value,'database':controldatabase,'channelname':channelsdata[data.index].name}
		// invoke ajax query with callback to update the interface when it's done
		UpdateControl(actionobj,UpdateChannelsData)
	  });
	  
	  // Toggle outputs enabled
	  $( "#channeloutputsenabledtoggle" + i ).on( 'slidestop', { index: i}, function( event ) { 
	    var data=event.data
		value=$(this).val()
		//alert("#channelsetpointvalueslider" + data.index)
		actionobj ={'action':'setchanneloutputsenabled','newstatus': value,'database':controldatabase,'channelname':channelsdata[data.index].name}
		// invoke ajax query with callback to update the interface when it's done
		UpdateControl(actionobj,UpdateChannelsData)
	  });
	  
	  //dropdowns
	  // Set positive output
	  $( "#channelpositiveoutputselect" + i ).on( 'slidestop', { index: i}, function( event ) { 
	    var data=event.data
		value=$(this).val()
		//alert("#channelsetpointvalueslider" + data.index)
		actionobj ={'action':'setposoutput','outputname':value,'channelname':channelsdata[data.index].name}
		// invoke ajax query with callback to update the interface when it's done
		UpdateControl(actionobj,UpdateChannelsData)
	  });



	<!--$('#channelscontainer').html(divhtmlstring)-->
	$('#channelset').collapsibleset('refresh')
	$('#channellistview').listview('refresh')
	UpdateChannelsData()

function GetAndRenderPlotData(channelindex, passedrenderplotids,passedrenderplotoptions){
	// pass classes to render to a global for use in the callback
	renderplotoptions=passedrenderplotoptions[0]
	renderplotids=passedrenderplotids
	
	logtablename=channelsdata[channelindex].name + "log"
	callbackoptions=renderplotoptions
	//alert(query)
	callback=RenderPlotData
	wsgiCallbackTableData (logdatabase,logtablename,callback,callbackoptions)
}
function RenderPlotData (returnedlogdata,plotoptions) {

	// clear out ids for render
	for (i=0;i<renderplotids.length;i++) {
		$('#' + renderplotids[i]).html('')
	}
	//console.log(returnedlogdata)
	
	setpointvalueseries=[]
	controlvalueseries=[]
	actionseries=[]
	for (i=0;i<returnedlogdata.length;i++){
		// put the data into a series format for jqplot
		controlvalueseries.push([returnedlogdata[i].time,returnedlogdata[i].controlvalue])
		setpointvalueseries.push([returnedlogdata[i].time,returnedlogdata[i].setpointvalue])
		actionseries.push([returnedlogdata[i].time,returnedlogdata[i].action])
		
	}
	if (controlvalueseries.length>0){
		for (i=0;i<renderplotids.length;i++){
			// take the ith class list and render dataseries to the classes
			//alert(renderplotids[i])
			$.jqplot(renderplotids[0], [controlvalueseries,setpointvalueseries,actionseries], plotoptions)   
			
		}
	}
	else{
		for (i=0;i<renderplotids.length;i++){
			$('#' + renderplotids[i]).html('No data available')
		}
	}
}


// this function is not currently used.

function UpdatePlot(index,plotid,plotoptions) {
	optionset=plotoptions || defaultoptions
	logtablename=channelsdata[index] + "log"

	xarray=[0,1,2,3,4,5,6,7,8,9]
	yarray=[1,2,4,3,6,8,2,5,3,3]
	xpoints=[]
	for (i=0;i<xarray.length;i++) {
		xpoints.push([xarray[i],yarray[i]])
	}
	// Clear out plot
	$('#'+plotid).html('')
	
	// Send data to plot
    var plot3 = $.jqplot(plotid, [xpoints], 
    { 
      series:[ 
          {
            // Change our line width and use a diamond shaped marker.
            lineWidth:2, 
            markerOptions: { style:'dimaond' }
          }, 
          {
            // Don't show a line, just show markers.
            // Make the markers 7 pixels with an 'x' style
            showLine:false, 
            markerOptions: { size: 7, style:"x" }
          },
          { 
            // Use (open) circlular markers.
            markerOptions: { style:"circle" }
          }, 
          {
            // Use a thicker, 5 pixel line and 10 pixel
            // filled square markers.
            lineWidth:5, 
            markerOptions: { style:"filledSquare", size:10 }
          }
      ]
    } 
  );
}

$(document).ready(function(){
	togglestolamps()
	//// Control Algorithms
	UpdateChannelsTable({'timeout':updateinterval})
	UpdateControlRecipes({'timeout':updateinterval})
  	UpdateControlAlgorithms({'timeout':updateinterval})
	UpdateInputs({'timeout':updateinterval})
	UpdateOutputs({'timeout':updateinterval})
	UpdateSystemStatusData({'timeout':updateinterval})
	UpdatePlotMetadata({'timeout':updateinterval})
	
	UpdateChannelsData({'timeout':updateinterval})
	
  // Plot stuff
 
    
});
</script>

  <div data-role="content">
	<div class="content-secondary">
	  <ul data-role="listview" data-inset="true">
		<li data-role="list-divider"><h4>Master Controls</h4></li>
		<li data-role="fieldcontain" >
            <span class="justalamp">
			  <label for="pcenabled" style="display:inline-block; width:50%; margin-top:0px!important">
			  <h3>Pi Control:</h3>
			  </label>
			  <select name="pcenabled" class="picontrolenabledtoggle" data-role="slider" >
                <option value="Off">Off</option>
                <option value="On">On</option>
			  </select> 
           </span>
		</li>
		<li data-role="fieldcontain">
          <span class="justalamp">
			  <label for="outputsenabled"  style="display:inline-block; width:50%;">
			  <h3>Outputs</h3>
			  </label>
			  <select name="outputsenabled" class="outputsenabledtoggle" data-role="slider">
			  <option value="Off">Off</option>
			  <option value="On">On</option>
			  </select> 
		  </span>
		</li>
		<li data-role="fieldcontain">
          <span class="justalamp">
			  <label for="inputsreadenabled"  style="display:inline-block; width:50%;">
			  <h3>Inputs Read:</h3>
			  </label>
			  <select name="inputsreadenabled" class="inputsreadenabledtoggle" data-role="slider">
			  <option value="Off">Off</option>
			  <option value="On">On</option>
			  </select> 
            </span>
		</li>

        <div data-role="collapsible" data-collapsed="true" data-inset="false" data-count-theme="b" data-content-theme="b">
           <h3>More</h3>
           <li data-role="fieldcontain" class="sm-inset-header">
                <fieldset class="ui-grid-a">
                  <div class="ui-block-a ui-stdlabel" >Last picontrol Poll</div>
                  <div class="ui-block-b ui-stdlabel lastpicontrolpoll">0</div>
                </fieldset>
            </li>
            <li data-role="fieldcontain" class="sm-inset-header">
                <fieldset class="ui-grid-a">
                  <div class="ui-block-a ui-stdlabel" >Last Inputs Poll</div>
                  <div class="ui-block-b ui-stdlabel lastinputspoll">0</div>
                </fieldset>
            </li>
            <li data-role="fieldcontain" class="sm-inset-header">
                <fieldset class="ui-grid-a">
                  <div class="ui-block-a ui-stdlabel" >System Message</div>
                  <div class="ui-block-b ui-stdlabel systemmessage">0</div>
                </fieldset>
            </li>
        </div>
        <div data-role="collapsible" data-collapsed="true" data-inset="false" data-count-theme="b" data-content-theme="b">
           <h3>Edit</h3>
             <li data-role="fieldcontain">
			  <label for="picontrolenabledtoggle" style="display:inline-block; width:50%;" class="ui-stdlabel sm-inset-header">Pi Control
			  </label>
			  <select name="picontrolenabledtoggle" class="picontrolenabledtoggle" data-role="slider" >
			  <option value="Off">Off</option>
			  <option value="On">On</option>
			  </select> 
			</li>
            <li data-role="fieldcontain">
			  <label for="flip-1"  style="display:inline-block; width:50%;" class="ui-stdlabel sm-inset-header">
			  Outputs
			  </label>
			  <select name="flip-1" class="outputsenabledtoggle" data-role="slider">
			  <option value="Off">Off</option>
			  <option value="On">On</option>
			  </select> 
		    </li>
            <li data-role="fieldcontain">
			  <label for="flip-1"  style="display:inline-block; width:50%;" class="ui-stdlabel sm-inset-header">
			  Inputs Read
			  </label>
			  <select name="flip-1" class="inputsreadenabledtoggle" data-role="slider">
			  <option value="Off">Off</option>
			  <option value="On">On</option>
			  </select> 
            </li>
            <li class="sm-inset-header">
            <label for="slider-1">Pi Control Freq:</label>
			<input type="range" name="slider-1" class="picontrolfreqslider" value="55" min="0" max="100" />
            </li>
            <li class="sm-inset-header">
			<label for="slider-1" >Input Poll Freq:</label>
			<input type="range" name="slider-1" class="inputsreadfreqslider" value="60" min="0" max="100" />
            </li>
        </div>
        <li data-role="fieldcontain">
		  <a href="systemstatus.html">System Status</a>
		</li>
	  </ul>
	</div><!--/content-secondary-->
	<div class="content-primary">
	  <ul data-role="listview" data-inset="true" data-dividertheme="c" id="channellistview">
		<li data-role="list-divider">
		  <h4>Channels</h4>
		</li>
        <div data-role="collapsible-set" data-inset="false" data-content-theme="b" id="channelset">
            <div data-role="collapsible" data-collapsed="true"  > <!--control item -->
              <h3>Channels loading ...</h3>
              <li data-role="fieldcontain">
                <fieldset class="ui-grid-a">
                  <div class="ui-block-a ui-biglabel inset-header">Control Value</div>
                  <div class="ui-block-b ui-biggerlabel inset-header">63</div>	   
                </fieldset>
              </li>
              <li data-role="fieldcontain">
                <fieldset class="ui-grid-a">
                  <div class="ui-block-a ui-biglabel inset-header">Setpoint Value
                  </div>
                  <div class="ui-block-b ui-biggerlabel inset-header">63</div>	   
                </fieldset>
              </li>               
              <li data-role="collapsible-set" data-content-theme="c" data-theme="d" data-inset="true">
                <div data-role="collapsible" data-collapsed="false" >
                  <h4>Edit</h4>
                  <ul data-role="listview" data-inset="false">
                    <li data-role="fieldcontain">
                      <label for="slider-1" class="ui-biglabel">Setpoint Value</label>
                      <input type="range" name="slider-1" id="slider-1" value="60" min="0" max="100" />
                    </li>
                    <li data-role="fieldcontain" >
                        <label for="flip-1" style="display:inline-block; width:45%;"><h3>Enabled:</h3></label>
                        <select name="flip-1" id="flip-1" data-role="slider">
                        <option value="off">Off</option>
                        <option value="on">On</option>
                        </select> 
                    </li>
                    <li data-role="fieldcontain">
                        <label for="flip-1" style="display:inline-block; width:45%;">
                        <h3>Outputs:</h3></label>
                        <select name="flip-1" id="flip-1" data-role="slider">
                        <option value="off">Off</option>
                        <option value="on">On</option>
                        </select> 
                    </li>
                    <li>
                      <div class="ui-grid-a">
                        <div class="ui-block-a">
                          <label for="selectpositiveoutput">Positive Output:</label>
                          <select name="selectpositiveoutput" id="selectpositiveoutput" class="selectoutput">
                              <option value="standard">Output 1</option>
                              <option value="rush">Output 2</option>
                              <option value="express">Output 3</option>
                              <option value="overnight">Output 4</option>
                          </select>
                        </div>
                        <div class="ui-block-b">
                          <label for="selectnegativeoutput">Negative Output:</label>
                          <select name="selectnegativeoutput" id="selectnegativeoutput" class="selectoutput">
                              <option value="standard">Output 1</option>
                              <option value="rush">Output 2</option>
                              <option value="express">Output 3</option>
                              <option value="overnight">Output 4</option>
                          </select>
                        </div>
                      </div><!--ui grid-->
                    </li><!-- list option set -->
                    <li>
                      <div class="ui-grid-a">
                        <div class="ui-block-a">
                          <label for="selectcontrolalgorithm">Control Algorithm</label>
                          <select name="selectcontrolalgorithm" class="selectcontrolalgorithm" id="blurg">
                              <option value="standard">on/off two degree deadband</option>
                              <option value="rush">on/off three degree deadband</option>
                              <option value="express">on/off two degree deadband</option>
                              <option value="value4">two degree deadband</option>
                          </select>
                        </div>
                        <div class="ui-block-b">
                          <label for="selectcontrolrecipe">Control Recipe</label>
                          <select name="selectcontrolrecipe" id="selectcontrolrecipe">
                              <option value="standard">stdreflow</option>
                              <option value="rush">Four-day 65F ale</option>
                              <option value="express">Six-day 65F ale</option>
                              <option value="overnight">Twelve-day 65F ale</option>
                          </select>
                        </div>
                      </div><!--ui grid-->
                    </li><!-- list option set -->
                  </ul><!-- Edit set-->
                </div><!-- Edit collapsible -->
                <div data-role="collapsible" data-collapsed="true" >
              		<h4>Quick Plot</h4>
              		<div id="plot1" class="quickplot"></div>
            	</div><!-- plot collapsible -->
              </li><!-- Edit Collapsible set -->
            </div><!--collapsible control item -->
         
        </div> <!-- collapsible channel controls item -->       
		<li data-role="fieldcontain">
		  <a href="settings.html">Channel Settings</a>
		</li>      
	  </ul>
	</div><!--content-primary-->
  </div><!--content-->
</div><!-- page -->
</body>
</html>
